{"ast":null,"code":"import _objectSpread from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from'react';import{Button,Icon}from'semantic-ui-react';import{formatTimestamp,getColorForStringHex,getDefaultPicture,iceServers}from'../../utils';import{UserMenu}from'../UserMenu/UserMenu';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export var VideoChat=/*#__PURE__*/function(_React$Component){_inherits(VideoChat,_React$Component);var _super=_createSuper(VideoChat);function VideoChat(){var _this;_classCallCheck(this,VideoChat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.socket=_this.props.socket;_this.handleSignal=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){var msg,from,pc,answer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// Handle messages received from signaling server\nmsg=data.msg;from=data.from;pc=window.watchparty.videoPCs[from];console.log('recv',from,data);if(!(msg.ice!==undefined)){_context.next=8;break;}pc.addIceCandidate(new RTCIceCandidate(msg.ice));_context.next=20;break;case 8:if(!(msg.sdp&&msg.sdp.type==='offer')){_context.next=19;break;}_context.next=11;return pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));case 11:_context.next=13;return pc.createAnswer();case 13:answer=_context.sent;_context.next=16;return pc.setLocalDescription(answer);case 16:_this.sendSignal(from,{sdp:pc.localDescription});_context.next=20;break;case 19:if(msg.sdp&&msg.sdp.type==='answer'){pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));}case 20:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.setupWebRTC=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var black,stream,_navigator,_navigator2,_navigator2$mediaDevi;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:// Set up our own video\n// Create default stream\nblack=function black(){var _canvas$getContext;var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref3$width=_ref3.width,width=_ref3$width===void 0?640:_ref3$width,_ref3$height=_ref3.height,height=_ref3$height===void 0?480:_ref3$height;var canvas=Object.assign(document.createElement('canvas'),{width:width,height:height});(_canvas$getContext=canvas.getContext('2d'))===null||_canvas$getContext===void 0?void 0:_canvas$getContext.fillRect(0,0,width,height);var stream=canvas.captureStream();return Object.assign(stream.getVideoTracks()[0],{enabled:false});};stream=new MediaStream([black()]);_context2.prev=2;_context2.next=5;return(_navigator=navigator)===null||_navigator===void 0?void 0:_navigator.mediaDevices.getUserMedia({audio:true,video:true});case 5:stream=_context2.sent;_context2.next=21;break;case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](2);console.warn(_context2.t0);_context2.prev=11;console.log('attempt audio only stream');_context2.next=15;return(_navigator2=navigator)===null||_navigator2===void 0?void 0:(_navigator2$mediaDevi=_navigator2.mediaDevices)===null||_navigator2$mediaDevi===void 0?void 0:_navigator2$mediaDevi.getUserMedia({audio:true,video:false});case 15:stream=_context2.sent;_context2.next=21;break;case 18:_context2.prev=18;_context2.t1=_context2[\"catch\"](11);console.warn(_context2.t1);case 21:window.watchparty.ourStream=stream;// alert server we've joined video chat\n_this.socket.emit('CMD:joinVideo');case 23:case\"end\":return _context2.stop();}}},_callee2,null,[[2,8],[11,18]]);}));_this.stopWebRTC=function(){var ourStream=window.watchparty.ourStream;var videoPCs=window.watchparty.videoPCs;ourStream&&ourStream.getTracks().forEach(function(track){track.stop();});window.watchparty.ourStream=undefined;Object.keys(videoPCs).forEach(function(key){videoPCs[key].close();delete videoPCs[key];});_this.socket.emit('CMD:leaveVideo');};_this.toggleVideoWebRTC=function(){var ourStream=window.watchparty.ourStream;if(ourStream&&ourStream.getVideoTracks()[0]){var _ourStream$getVideoTr;ourStream.getVideoTracks()[0].enabled=!((_ourStream$getVideoTr=ourStream.getVideoTracks()[0])===null||_ourStream$getVideoTr===void 0?void 0:_ourStream$getVideoTr.enabled);}_this.forceUpdate();};_this.getVideoWebRTC=function(){var _ourStream$getVideoTr2;var ourStream=window.watchparty.ourStream;return ourStream&&((_ourStream$getVideoTr2=ourStream.getVideoTracks()[0])===null||_ourStream$getVideoTr2===void 0?void 0:_ourStream$getVideoTr2.enabled);};_this.toggleAudioWebRTC=function(){var ourStream=window.watchparty.ourStream;if(ourStream&&ourStream.getAudioTracks()[0]){var _ourStream$getAudioTr;ourStream.getAudioTracks()[0].enabled=!((_ourStream$getAudioTr=ourStream.getAudioTracks()[0])===null||_ourStream$getAudioTr===void 0?void 0:_ourStream$getAudioTr.enabled);}_this.forceUpdate();};_this.getAudioWebRTC=function(){var ourStream=window.watchparty.ourStream;return ourStream&&ourStream.getAudioTracks()[0]&&ourStream.getAudioTracks()[0].enabled;};_this.updateWebRTC=function(){var ourStream=window.watchparty.ourStream;var videoPCs=window.watchparty.videoPCs;var videoRefs=window.watchparty.videoRefs;if(!ourStream){// We haven't started video chat, exit\nreturn;}_this.props.participants.forEach(function(user){var id=user.id;if(!user.isVideoChat&&videoPCs[id]){// User isn't in video chat but we have a connection, close it\nvideoPCs[id].close();delete videoPCs[id];}if(!user.isVideoChat||videoPCs[id]){// User isn't in video chat, or we already have a connection to them\nreturn;}if(id===_this.socket.id){videoPCs[id]=new RTCPeerConnection();videoRefs[id].srcObject=ourStream;}else{var pc=new RTCPeerConnection({iceServers:iceServers()});videoPCs[id]=pc;// Add our own video as outgoing stream\nourStream===null||ourStream===void 0?void 0:ourStream.getTracks().forEach(function(track){if(ourStream){pc.addTrack(track,ourStream);}});pc.onicecandidate=function(event){// We generated an ICE candidate, send it to peer\nif(event.candidate){_this.sendSignal(id,{ice:event.candidate});}};pc.ontrack=function(event){// Mount the stream from peer\n// console.log(stream);\nvideoRefs[id].srcObject=event.streams[0];};// For each pair, have the lexicographically smaller ID be the offerer\nvar isOfferer=_this.socket.id<id;if(isOfferer){pc.onnegotiationneeded=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var offer;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return pc.createOffer();case 2:offer=_context3.sent;_context3.next=5;return pc.setLocalDescription(offer);case 5:_this.sendSignal(id,{sdp:pc.localDescription});case 6:case\"end\":return _context3.stop();}}},_callee3);}));}}});};_this.sendSignal=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(to,data){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log('send',to,data);_this.socket.emit('signal',{to:to,msg:data});case 2:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x2,_x3){return _ref5.apply(this,arguments);};}();return _this;}_createClass(VideoChat,[{key:\"componentDidMount\",value:function componentDidMount(){this.socket.on('signal',this.handleSignal);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.socket.off('signal',this.handleSignal);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(this.props.rosterUpdateTS!==prevProps.rosterUpdateTS){this.updateWebRTC();}}},{key:\"render\",value:function render(){var _this$props=this.props,participants=_this$props.participants,pictureMap=_this$props.pictureMap,nameMap=_this$props.nameMap,tsMap=_this$props.tsMap,socket=_this$props.socket,owner=_this$props.owner,user=_this$props.user;var ourStream=window.watchparty.ourStream;var videoRefs=window.watchparty.videoRefs;var videoChatContentStyle={height:participants.length<3?220:110,borderRadius:'4px',objectFit:'contain'};return/*#__PURE__*/_jsxs(\"div\",{style:{display:this.props.hide?'none':'flex',width:'100%',flexDirection:'column',overflow:'auto'},children:[!ourStream&&/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',marginTop:'8px'},children:/*#__PURE__*/_jsxs(Button,{fluid:true,title:\"Join Video Chat\",color:'purple',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.setupWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"video\"}),\"Join Video Chat\"]})}),ourStream&&/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',flexWrap:'wrap'},children:[/*#__PURE__*/_jsxs(Button,{fluid:true,color:'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.stopWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"external\"}),\"Leave Video Chat\"]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'center',marginTop:'8px',width:'100%'},children:[/*#__PURE__*/_jsxs(Button,{color:this.getVideoWebRTC()?'green':'red',fluid:true,size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleVideoWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"video\"}),this.getVideoWebRTC()?'On':'Off']}),/*#__PURE__*/_jsxs(Button,{color:this.getAudioWebRTC()?'green':'red',fluid:true,size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleAudioWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:this.getAudioWebRTC()?'microphone':'microphone slash'}),this.getAudioWebRTC()?'On':'Off']})]})]}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',justifyContent:'center',marginTop:'8px'},children:participants.map(function(p){return/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"div\",{style:{position:'relative'//marginLeft: '4px',\n},children:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(UserMenu,{displayName:nameMap[p.id]||p.id,user:user,disabled:!Boolean(owner&&owner===(user===null||user===void 0?void 0:user.uid)),position:'left center',socket:socket,userToManage:p.id,trigger:/*#__PURE__*/_jsx(Icon,{name:\"ellipsis vertical\",size:\"large\",style:{position:'absolute',right:-7,top:5,cursor:'pointer',opacity:0.75,visibility:Boolean(owner&&owner===(user===null||user===void 0?void 0:user.uid))?'visible':'hidden'}})}),ourStream&&p.isVideoChat?/*#__PURE__*/_jsx(\"video\",{ref:function ref(el){if(el){videoRefs[p.id]=el;}},style:_objectSpread(_objectSpread({},videoChatContentStyle),{},{// mirror the video if it's our stream. this style mimics Zoom where your\n// video is mirrored only for you)\ntransform:\"scaleX(\".concat(p.id===socket.id?'-1':'1',\")\")}),autoPlay:true,muted:p.id===socket.id,\"data-id\":p.id}):/*#__PURE__*/_jsx(\"img\",{style:videoChatContentStyle,src:pictureMap[p.id]||getDefaultPicture(nameMap[p.id],getColorForStringHex(p.id)),alt:\"\"}),/*#__PURE__*/_jsxs(\"div\",{style:{position:'absolute',bottom:'4px',left:'0px',width:'100%',backgroundColor:'rgba(0,0,0,0)',color:'white',borderRadius:'4px',fontSize:'10px',fontWeight:700,display:'flex'},children:[/*#__PURE__*/_jsxs(\"div\",{title:nameMap[p.id]||p.id,style:{width:'80px',backdropFilter:'brightness(80%)',padding:'4px',textOverflow:'ellipsis',whiteSpace:'nowrap',overflow:'hidden',display:'inline-block'},children:[p.isVideoChat&&/*#__PURE__*/_jsx(Icon,{size:\"small\",name:\"video\"}),nameMap[p.id]||p.id]}),/*#__PURE__*/_jsx(\"div\",{style:{backdropFilter:'brightness(60%)',padding:'4px',flexGrow:1,display:'flex',justifyContent:'center'},children:formatTimestamp(tsMap[p.id]||0)})]})]})})},p.id);})})]});}}]);return VideoChat;}(React.Component);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/VideoChat/VideoChat.tsx"],"names":["React","Button","Icon","formatTimestamp","getColorForStringHex","getDefaultPicture","iceServers","UserMenu","VideoChat","socket","props","handleSignal","data","msg","from","pc","window","watchparty","videoPCs","console","log","ice","undefined","addIceCandidate","RTCIceCandidate","sdp","type","setRemoteDescription","RTCSessionDescription","createAnswer","answer","setLocalDescription","sendSignal","localDescription","setupWebRTC","black","width","height","canvas","Object","assign","document","createElement","getContext","fillRect","stream","captureStream","getVideoTracks","enabled","MediaStream","navigator","mediaDevices","getUserMedia","audio","video","warn","ourStream","emit","stopWebRTC","getTracks","forEach","track","stop","keys","key","close","toggleVideoWebRTC","forceUpdate","getVideoWebRTC","toggleAudioWebRTC","getAudioTracks","getAudioWebRTC","updateWebRTC","videoRefs","participants","user","id","isVideoChat","RTCPeerConnection","srcObject","addTrack","onicecandidate","event","candidate","ontrack","streams","isOfferer","onnegotiationneeded","createOffer","offer","to","on","off","prevProps","rosterUpdateTS","pictureMap","nameMap","tsMap","owner","videoChatContentStyle","length","borderRadius","objectFit","display","hide","flexDirection","overflow","flexWrap","marginTop","justifyContent","map","p","position","Boolean","uid","right","top","cursor","opacity","visibility","el","transform","bottom","left","backgroundColor","color","fontSize","fontWeight","backdropFilter","padding","textOverflow","whiteSpace","flexGrow","Component"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Button, Icon } from 'semantic-ui-react';\nimport { Socket } from 'socket.io-client';\n\nimport {\n  formatTimestamp,\n  getColorForStringHex,\n  getDefaultPicture,\n  iceServers,\n} from '../../utils';\nimport { UserMenu } from '../UserMenu/UserMenu';\nimport firebase from 'firebase/compat/app';\n\ninterface VideoChatProps {\n  socket: Socket;\n  participants: User[];\n  pictureMap: StringDict;\n  nameMap: StringDict;\n  tsMap: NumberDict;\n  rosterUpdateTS: Number;\n  hide?: boolean;\n  owner: string | undefined;\n  user: firebase.User | undefined;\n}\n\nexport class VideoChat extends React.Component<VideoChatProps> {\n  socket = this.props.socket;\n\n  componentDidMount() {\n    this.socket.on('signal', this.handleSignal);\n  }\n\n  componentWillUnmount() {\n    this.socket.off('signal', this.handleSignal);\n  }\n\n  componentDidUpdate(prevProps: VideoChatProps) {\n    if (this.props.rosterUpdateTS !== prevProps.rosterUpdateTS) {\n      this.updateWebRTC();\n    }\n  }\n\n  handleSignal = async (data: any) => {\n    // Handle messages received from signaling server\n    const msg = data.msg;\n    const from = data.from;\n    const pc = window.watchparty.videoPCs[from];\n    console.log('recv', from, data);\n    if (msg.ice !== undefined) {\n      pc.addIceCandidate(new RTCIceCandidate(msg.ice));\n    } else if (msg.sdp && msg.sdp.type === 'offer') {\n      // console.log('offer');\n      await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n      const answer = await pc.createAnswer();\n      await pc.setLocalDescription(answer);\n      this.sendSignal(from, { sdp: pc.localDescription });\n    } else if (msg.sdp && msg.sdp.type === 'answer') {\n      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n    }\n  };\n\n  setupWebRTC = async () => {\n    // Set up our own video\n    // Create default stream\n    let black = ({ width = 640, height = 480 } = {}) => {\n      let canvas: any = Object.assign(document.createElement('canvas'), {\n        width,\n        height,\n      });\n      canvas.getContext('2d')?.fillRect(0, 0, width, height);\n      let stream = canvas.captureStream();\n      return Object.assign(stream.getVideoTracks()[0], { enabled: false });\n    };\n    let stream = new MediaStream([black()]);\n\n    try {\n      stream = await navigator?.mediaDevices.getUserMedia({\n        audio: true,\n        video: true,\n      });\n    } catch (e) {\n      console.warn(e);\n      try {\n        console.log('attempt audio only stream');\n        stream = await navigator?.mediaDevices?.getUserMedia({\n          audio: true,\n          video: false,\n        });\n      } catch (e) {\n        console.warn(e);\n      }\n    }\n    window.watchparty.ourStream = stream;\n    // alert server we've joined video chat\n    this.socket.emit('CMD:joinVideo');\n  };\n\n  stopWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    const videoPCs = window.watchparty.videoPCs;\n    ourStream &&\n      ourStream.getTracks().forEach((track) => {\n        track.stop();\n      });\n    window.watchparty.ourStream = undefined;\n    Object.keys(videoPCs).forEach((key) => {\n      videoPCs[key].close();\n      delete videoPCs[key];\n    });\n    this.socket.emit('CMD:leaveVideo');\n  };\n\n  toggleVideoWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    if (ourStream && ourStream.getVideoTracks()[0]) {\n      ourStream.getVideoTracks()[0].enabled =\n        !ourStream.getVideoTracks()[0]?.enabled;\n    }\n    this.forceUpdate();\n  };\n\n  getVideoWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    return ourStream && ourStream.getVideoTracks()[0]?.enabled;\n  };\n\n  toggleAudioWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    if (ourStream && ourStream.getAudioTracks()[0]) {\n      ourStream.getAudioTracks()[0].enabled =\n        !ourStream.getAudioTracks()[0]?.enabled;\n    }\n    this.forceUpdate();\n  };\n\n  getAudioWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    return (\n      ourStream &&\n      ourStream.getAudioTracks()[0] &&\n      ourStream.getAudioTracks()[0].enabled\n    );\n  };\n\n  updateWebRTC = () => {\n    const ourStream = window.watchparty.ourStream;\n    const videoPCs = window.watchparty.videoPCs;\n    const videoRefs = window.watchparty.videoRefs;\n    if (!ourStream) {\n      // We haven't started video chat, exit\n      return;\n    }\n    this.props.participants.forEach((user) => {\n      const id = user.id;\n      if (!user.isVideoChat && videoPCs[id]) {\n        // User isn't in video chat but we have a connection, close it\n        videoPCs[id].close();\n        delete videoPCs[id];\n      }\n      if (!user.isVideoChat || videoPCs[id]) {\n        // User isn't in video chat, or we already have a connection to them\n        return;\n      }\n      if (id === this.socket.id) {\n        videoPCs[id] = new RTCPeerConnection();\n        videoRefs[id].srcObject = ourStream;\n      } else {\n        const pc = new RTCPeerConnection({ iceServers: iceServers() });\n        videoPCs[id] = pc;\n        // Add our own video as outgoing stream\n        ourStream?.getTracks().forEach((track) => {\n          if (ourStream) {\n            pc.addTrack(track, ourStream);\n          }\n        });\n        pc.onicecandidate = (event) => {\n          // We generated an ICE candidate, send it to peer\n          if (event.candidate) {\n            this.sendSignal(id, { ice: event.candidate });\n          }\n        };\n        pc.ontrack = (event: RTCTrackEvent) => {\n          // Mount the stream from peer\n          // console.log(stream);\n          videoRefs[id].srcObject = event.streams[0];\n        };\n        // For each pair, have the lexicographically smaller ID be the offerer\n        const isOfferer = this.socket.id < id;\n        if (isOfferer) {\n          pc.onnegotiationneeded = async () => {\n            // Start connection for peer's video\n            const offer = await pc.createOffer();\n            await pc.setLocalDescription(offer);\n            this.sendSignal(id, { sdp: pc.localDescription });\n          };\n        }\n      }\n    });\n  };\n\n  sendSignal = async (to: string, data: any) => {\n    console.log('send', to, data);\n    this.socket.emit('signal', { to, msg: data });\n  };\n\n  render() {\n    const { participants, pictureMap, nameMap, tsMap, socket, owner, user } =\n      this.props;\n    const ourStream = window.watchparty.ourStream;\n    const videoRefs = window.watchparty.videoRefs;\n    const videoChatContentStyle = {\n      height: participants.length < 3 ? 220 : 110,\n      borderRadius: '4px',\n      objectFit: 'contain',\n    };\n    return (\n      <div\n        style={{\n          display: this.props.hide ? 'none' : 'flex',\n          width: '100%',\n          flexDirection: 'column',\n          overflow: 'auto',\n        }}\n      >\n        {!ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n              marginTop: '8px',\n            }}\n          >\n            <Button\n              fluid\n              title=\"Join Video Chat\"\n              color={'purple'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.setupWebRTC}\n            >\n              <Icon name=\"video\" />\n              {`Join Video Chat`}\n            </Button>\n          </div>\n        )}\n        {ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n            }}\n          >\n            <Button\n              fluid\n              color={'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.stopWebRTC}\n            >\n              <Icon name=\"external\" />\n              {`Leave Video Chat`}\n            </Button>\n            <div\n              style={{\n                display: 'flex',\n                justifyContent: 'center',\n                marginTop: '8px',\n                width: '100%',\n              }}\n            >\n              <Button\n                color={this.getVideoWebRTC() ? 'green' : 'red'}\n                fluid\n                size=\"medium\"\n                icon\n                labelPosition=\"left\"\n                onClick={this.toggleVideoWebRTC}\n              >\n                <Icon name=\"video\" />\n                {this.getVideoWebRTC() ? 'On' : 'Off'}\n              </Button>\n              <Button\n                color={this.getAudioWebRTC() ? 'green' : 'red'}\n                fluid\n                size=\"medium\"\n                icon\n                labelPosition=\"left\"\n                onClick={this.toggleAudioWebRTC}\n              >\n                <Icon\n                  name={\n                    this.getAudioWebRTC() ? 'microphone' : 'microphone slash'\n                  }\n                />\n                {this.getAudioWebRTC() ? 'On' : 'Off'}\n              </Button>\n            </div>\n          </div>\n        )}\n        <div\n          style={{\n            display: 'flex',\n            flexWrap: 'wrap',\n            justifyContent: 'center',\n            marginTop: '8px',\n          }}\n        >\n          {participants.map((p) => {\n            return (\n              <div key={p.id}>\n                <div\n                  style={{\n                    position: 'relative',\n                    //marginLeft: '4px',\n                  }}\n                >\n                  <div>\n                    <UserMenu\n                      displayName={nameMap[p.id] || p.id}\n                      user={user}\n                      disabled={!Boolean(owner && owner === user?.uid)}\n                      position={'left center'}\n                      socket={socket}\n                      userToManage={p.id}\n                      trigger={\n                        <Icon\n                          name=\"ellipsis vertical\"\n                          size=\"large\"\n                          style={{\n                            position: 'absolute',\n                            right: -7,\n                            top: 5,\n                            cursor: 'pointer',\n                            opacity: 0.75,\n                            visibility: Boolean(owner && owner === user?.uid)\n                              ? 'visible'\n                              : 'hidden',\n                          }}\n                        />\n                      }\n                    />\n                    {ourStream && p.isVideoChat ? (\n                      <video\n                        ref={(el) => {\n                          if (el) {\n                            videoRefs[p.id] = el;\n                          }\n                        }}\n                        style={{\n                          ...(videoChatContentStyle as any),\n                          // mirror the video if it's our stream. this style mimics Zoom where your\n                          // video is mirrored only for you)\n                          transform: `scaleX(${\n                            p.id === socket.id ? '-1' : '1'\n                          })`,\n                        }}\n                        autoPlay\n                        muted={p.id === socket.id}\n                        data-id={p.id}\n                      />\n                    ) : (\n                      <img\n                        style={videoChatContentStyle as any}\n                        src={\n                          pictureMap[p.id] ||\n                          getDefaultPicture(\n                            nameMap[p.id],\n                            getColorForStringHex(p.id)\n                          )\n                        }\n                        alt=\"\"\n                      />\n                    )}\n                    <div\n                      style={{\n                        position: 'absolute',\n                        bottom: '4px',\n                        left: '0px',\n                        width: '100%',\n                        backgroundColor: 'rgba(0,0,0,0)',\n                        color: 'white',\n                        borderRadius: '4px',\n                        fontSize: '10px',\n                        fontWeight: 700,\n                        display: 'flex',\n                      }}\n                    >\n                      <div\n                        title={nameMap[p.id] || p.id}\n                        style={{\n                          width: '80px',\n                          backdropFilter: 'brightness(80%)',\n                          padding: '4px',\n                          textOverflow: 'ellipsis',\n                          whiteSpace: 'nowrap',\n                          overflow: 'hidden',\n                          display: 'inline-block',\n                        }}\n                      >\n                        {p.isVideoChat && <Icon size=\"small\" name=\"video\" />}\n                        {nameMap[p.id] || p.id}\n                      </div>\n                      <div\n                        style={{\n                          backdropFilter: 'brightness(60%)',\n                          padding: '4px',\n                          flexGrow: 1,\n                          display: 'flex',\n                          justifyContent: 'center',\n                        }}\n                      >\n                        {formatTimestamp(tsMap[p.id] || 0)}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}